name: AI Status Monitor - Bot Status Update

on:
  schedule:
    - cron: "*/5 * * * *"   # 5ë¶„ë§ˆë‹¤ (UTC ê¸°ì¤€)
  workflow_dispatch:        # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  poll-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

        # jq ì„¤ì¹˜ (ubuntu-latestì— ê¸°ë³¸ íƒ‘ì¬ë˜ì–´ ìˆì§€ë§Œ ë³´ìˆ˜ì ìœ¼ë¡œ ì„¤ì¹˜)
      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch OpenAI Status (ChatGPT component)
        id: fetch
        run: |
          set -euo pipefail
          URL="https://status.openai.com/api/v2/summary.json"
          JSON="$(curl -fsSL "$URL")"
          # ChatGPT ì»´í¬ë„ŒíŠ¸ ìƒíƒœë§Œ ì¶”ì¶œ(ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
          STATUS="$(echo "$JSON" | jq -r '.components[] | select(.name|test("ChatGPT";"i")) | .status' || true)"
          if [ -z "$STATUS" ] || [ "$STATUS" = "null" ]; then
            # ì»´í¬ë„ŒíŠ¸ ëª…ì´ ë³€í•  ê°€ëŠ¥ì„±ì— ëŒ€ë¹„: API ì „ì²´ ì§€í‘œ(ë³´ìˆ˜ì  Yellow) ì‚¬ìš©
            STATUS="unknown"
          fi
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"

      - name: Update bot display name and status
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          set -euo pipefail
          
          # ìƒíƒœì— ë”°ë¥¸ ë´‡ ì´ë¦„ê³¼ ì´ëª¨ì§€ ì„¤ì •
          case "${{ steps.fetch.outputs.status }}" in
            operational) 
              BOT_NAME="AI Monitor ğŸŸ¢"
              STATUS_EMOJI=":white_check_mark:"
              STATUS_TEXT="OpenAI ì •ìƒ ì‘ë™ ì¤‘"
              ;;
            degraded_performance) 
              BOT_NAME="AI Monitor ğŸŸ¡"
              STATUS_EMOJI=":warning:"
              STATUS_TEXT="OpenAI ì„±ëŠ¥ ì €í•˜"
              ;;
            partial_outage|major_outage) 
              BOT_NAME="AI Monitor ğŸ”´"
              STATUS_EMOJI=":x:"
              STATUS_TEXT="OpenAI ì¥ì•  ë°œìƒ"
              ;;
            *) 
              BOT_NAME="AI Monitor âš ï¸"
              STATUS_EMOJI=":question:"
              STATUS_TEXT="OpenAI ìƒíƒœ ë¶ˆëª…"
              ;;
          esac
          
          echo "Bot Name: $BOT_NAME"
          echo "Status: ${{ steps.fetch.outputs.status }}"
          echo "Status Text: $STATUS_TEXT"
          
          # ë´‡ì˜ display name ì—…ë°ì´íŠ¸ (users.profile.set ì‚¬ìš©)
          curl -sS -X POST \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "{\"profile\":{\"display_name\":\"${BOT_NAME}\"}}" \
            "https://slack.com/api/users.profile.set" \
          | jq -r '.'
          
          # ë´‡ì˜ ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
          curl -sS -X POST \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "{\"profile\":{\"status_emoji\":\"${STATUS_EMOJI}\",\"status_text\":\"${STATUS_TEXT}\"}}" \
            "https://slack.com/api/users.profile.set" \
          | jq -r '.'
