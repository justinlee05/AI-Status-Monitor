name: ChatGPT Status to Slack Icon

on:
  schedule:
    - cron: "*/5 * * * *"   # 5ë¶„ë§ˆë‹¤ (UTC ê¸°ì¤€)
  workflow_dispatch:        # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  poll-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (icons only)
        uses: actions/checkout@v4

        # jq ì„¤ì¹˜ (ubuntu-latestì— ê¸°ë³¸ íƒ‘ì¬ë˜ì–´ ìˆì§€ë§Œ ë³´ìˆ˜ì ìœ¼ë¡œ ì„¤ì¹˜)
      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch OpenAI Status (ChatGPT component)
        id: fetch
        run: |
          set -euo pipefail
          URL="https://status.openai.com/api/v2/summary.json"
          JSON="$(curl -fsSL "$URL")"
          # ChatGPT ì»´í¬ë„ŒíŠ¸ ìƒíƒœë§Œ ì¶”ì¶œ(ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
          STATUS="$(echo "$JSON" | jq -r '.components[] | select(.name|test("ChatGPT";"i")) | .status' || true)"
          if [ -z "$STATUS" ] || [ "$STATUS" = "null" ]; then
            # ì»´í¬ë„ŒíŠ¸ ëª…ì´ ë³€í•  ê°€ëŠ¥ì„±ì— ëŒ€ë¹„: API ì „ì²´ ì§€í‘œ(ë³´ìˆ˜ì  Yellow) ì‚¬ìš©
            STATUS="unknown"
          fi
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"

      - name: Decide icon color
        id: color
        run: |
          set -euo pipefail
          case "${{ steps.fetch.outputs.status }}" in
            operational) COLOR="green" ;;
            degraded_performance) COLOR="yellow" ;;
            partial_outage|major_outage) COLOR="red" ;;
            *) COLOR="yellow" ;;  # unknown/maintenance ë“±ì€ ê²½ê³ ìƒ‰ìœ¼ë¡œ
          esac
          echo "color=$COLOR" >> "$GITHUB_OUTPUT"

      - name: Set Slack profile photo (users.setPhoto)
        env:
          SLACK_USER_TOKEN: ${{ secrets.SLACK_USER_TOKEN }}
        run: |
          set -euo pipefail
          ICON="icons/${{ steps.color.outputs.color }}.png"
          if [ ! -f "$ICON" ]; then
            echo "Icon not found: $ICON" >&2
            exit 1
          fi
          # Slack Web API: users.setPhoto (multipart)
          curl -sS -F "image=@${ICON}" \
               -H "Authorization: Bearer ${SLACK_USER_TOKEN}" \
               https://slack.com/api/users.setPhoto \
            | jq -r '.'

      # ì„ íƒ: ìƒíƒœ ë³€ê²½ì‹œ ì±„ë„ ì•Œë¦¼ (ë´‡ í† í° í•„ìš”)
      # - name: Notify channel
      #   if: always()
      #   env:
      #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      #   run: |
      #     CHANNEL="#ai-status"  # ì±„ë„ IDë‚˜ ì´ë¦„
      #     TEXT="ChatGPT ìƒíƒœ ì•„ì´ì½˜ ê°±ì‹ : ${{ steps.color.outputs.color == 'green' && 'ğŸŸ¢ ì •ìƒ' || steps.color.outputs.color == 'yellow' && 'ğŸŸ¡ ê²½ë¯¸ ì´ìŠˆ/ë¯¸í™•ì¸' || 'ğŸ”´ ì¥ì• ' }}"
      #     curl -sS -X POST "https://slack.com/api/chat.postMessage" \
      #       -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
      #       -H "Content-type: application/json; charset=utf-8" \
      #       --data "{\"channel\":\"${CHANNEL}\",\"text\":\"${TEXT}\"}" \
      #     | jq -r '.'
