name: AI Status Monitor - Bot Status Update

on:
  schedule:
    - cron: "*/5 * * * *"   # 5ë¶„ë§ˆë‹¤ (UTC ê¸°ì¤€)
  workflow_dispatch:        # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  poll-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

        # jq ì„¤ì¹˜ (ubuntu-latestì— ê¸°ë³¸ íƒ‘ìž¬ë˜ì–´ ìžˆì§€ë§Œ ë³´ìˆ˜ì ìœ¼ë¡œ ì„¤ì¹˜)
      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch OpenAI Status (Chat component)
        id: fetch
        run: |
          set -euo pipefail
          URL="https://status.openai.com/api/v2/summary.json"
          JSON="$(curl -fsSL "$URL")"
          
          # Chat ì»´í¬ë„ŒíŠ¸ ìƒíƒœ ì¶”ì¶œ (ChatGPT ëŒ€ì‹  Chat ì‚¬ìš©)
          STATUS="$(echo "$JSON" | jq -r '.components[] | select(.name|test("Chat";"i")) | .status' || true)"
          if [ -z "$STATUS" ] || [ "$STATUS" = "null" ]; then
            # Chat ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì „ì²´ ìƒíƒœ ì‚¬ìš©
            OVERALL_STATUS="$(echo "$JSON" | jq -r '.status.indicator' || true)"
            case "$OVERALL_STATUS" in
              "none") STATUS="operational" ;;
              "minor") STATUS="degraded_performance" ;;
              "major") STATUS="major_outage" ;;
              *) STATUS="unknown" ;;
            esac
          fi
          
          # ìƒíƒœ ì •ë¦¬ (ì²« ë²ˆì§¸ ì¤„ë§Œ ì‚¬ìš©)
          STATUS=$(echo "$STATUS" | head -n1 | tr -d '\n\r')
          
          echo "Found status: '$STATUS'"
          
          # GitHub Actions output (ê°„ë‹¨í•œ í˜•ì‹)
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"

      - name: Update bot display name and status
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          set -euo pipefail
          
          # Slack í† í° í™•ì¸
          if [ -z "${SLACK_BOT_TOKEN:-}" ]; then
            echo "ERROR: SLACK_BOT_TOKEN is not set!"
            echo "Please add SLACK_BOT_TOKEN to repository secrets."
            exit 1
          fi
          
          # í˜„ìž¬ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
          CURRENT_STATUS="${{ steps.fetch.outputs.status }}"
          echo "Current status: '$CURRENT_STATUS'"
          
          # ìƒíƒœì— ë”°ë¥¸ ë´‡ ì´ë¦„ê³¼ ì´ëª¨ì§€ ì„¤ì •
          case "$CURRENT_STATUS" in
            operational) 
              BOT_NAME="AI Monitor ðŸŸ¢"
              STATUS_EMOJI=":white_check_mark:"
              STATUS_TEXT="OpenAI ì •ìƒ ìž‘ë™ ì¤‘"
              ;;
            degraded_performance) 
              BOT_NAME="AI Monitor ðŸŸ¡"
              STATUS_EMOJI=":warning:"
              STATUS_TEXT="OpenAI ì„±ëŠ¥ ì €í•˜"
              ;;
            partial_outage|major_outage) 
              BOT_NAME="AI Monitor ðŸ”´"
              STATUS_EMOJI=":x:"
              STATUS_TEXT="OpenAI ìž¥ì•  ë°œìƒ"
              ;;
            *) 
              BOT_NAME="AI Monitor âš ï¸"
              STATUS_EMOJI=":question:"
              STATUS_TEXT="OpenAI ìƒíƒœ ë¶ˆëª… ($CURRENT_STATUS)"
              ;;
          esac
          
          echo "=== DEBUG INFO ==="
          echo "Bot Name: $BOT_NAME"
          echo "Status: $CURRENT_STATUS"
          echo "Status Text: $STATUS_TEXT"
          echo "Status Emoji: $STATUS_EMOJI"
          echo "Token present: $([ -n "${SLACK_BOT_TOKEN:-}" ] && echo "YES" || echo "NO")"
          echo "Token length: ${#SLACK_BOT_TOKEN}"
          echo "=================="
          
          # JSON íŽ˜ì´ë¡œë“œ ìƒì„± (íŠ¹ìˆ˜ë¬¸ìž ì•ˆì „ ì²˜ë¦¬)
          DISPLAY_NAME_PAYLOAD=$(jq -n --arg name "$BOT_NAME" '{profile: {display_name: $name}}')
          STATUS_PAYLOAD=$(jq -n --arg emoji "$STATUS_EMOJI" --arg text "$STATUS_TEXT" '{profile: {status_emoji: $emoji, status_text: $text}}')
          
          # ë¨¼ì € ë´‡ ì •ë³´ í™•ì¸
          echo "Testing Slack API connection..."
          AUTH_TEST=$(curl -sS \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            "https://slack.com/api/auth.test")
          
          echo "Auth test response: $AUTH_TEST"
          
          if echo "$AUTH_TEST" | jq -e '.ok == false' > /dev/null; then
            echo "ERROR: Slack authentication failed"
            echo "$AUTH_TEST" | jq -r '.error // "Unknown error"'
            exit 1
          fi
          
          # ë´‡ì˜ display name ì—…ë°ì´íŠ¸
          echo "Updating display name..."
          RESPONSE1=$(curl -sS -X POST \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "$DISPLAY_NAME_PAYLOAD" \
            "https://slack.com/api/users.profile.set")
          
          echo "Display name response: $RESPONSE1"
          
          # ë´‡ì˜ ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
          echo "Updating status message..."
          RESPONSE2=$(curl -sS -X POST \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "$STATUS_PAYLOAD" \
            "https://slack.com/api/users.profile.set")
          
          echo "Status message response: $RESPONSE2"
          
          # ì—ëŸ¬ ì²´í¬
          if echo "$RESPONSE1" | jq -e '.ok == false' > /dev/null; then
            echo "ERROR: Display name update failed"
            echo "$RESPONSE1" | jq -r '.error // "Unknown error"'
          fi
          
          if echo "$RESPONSE2" | jq -e '.ok == false' > /dev/null; then
            echo "ERROR: Status message update failed"
            echo "$RESPONSE2" | jq -r '.error // "Unknown error"'
          fi
